<!-- index.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Derecho Administrativo ¬∑ Temas</title>
  <meta name="description" content="√çndice de temas con acceso r√°pido, b√∫squeda y progreso." />

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.085);
      --bd: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --chip: rgba(255,255,255,.10);
      --good: #22c55e;
      --warn: #f59e0b;
      --brand: #60a5fa;
      --brand2: #a78bfa;
      --danger: #fb7185;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(1000px 700px at 95% 10%, rgba(167,139,250,.20), transparent 55%),
        radial-gradient(900px 700px at 35% 105%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, #070b14 0%, #0b1220 55%, #070b14 100%);
      min-height:100vh;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 16px 40px;
    }

    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 260px;
    }

    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 560px;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--bd);
      border-radius: 999px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .pill small{
      color: var(--muted2);
      font-size: 12px;
    }
    .pill b{
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 650;
      letter-spacing:.2px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--bd);
      background: var(--panel);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:650;
      font-size: 13px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: var(--panel2); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(96,165,250,.22), rgba(167,139,250,.18));
      border-color: rgba(96,165,250,.35);
    }
    .btn.danger{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.38);
    }

    .toolbar{
      margin: 18px 0 14px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }

    .search{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px 14px;
      background: var(--panel);
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--txt);
      font-size: 14px;
    }
    .search input::placeholder{ color: rgba(255,255,255,.45); }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background: var(--chip);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: background .2s ease, border-color .2s ease;
    }
    .chip:hover{ border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.12); }
    .chip.active{ border-color: rgba(96,165,250,.55); background: rgba(96,165,250,.16); color: rgba(255,255,255,.85); }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .toolbar{ grid-template-columns: 1fr; } .chips{ justify-content:flex-start; } .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px 14px 12px;
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.35), transparent 60%);
      filter: blur(0px);
      pointer-events:none;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 8px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .title h3{
      margin:0;
      font-size: 15px;
      line-height:1.2;
      letter-spacing:.1px;
      word-break: break-word;
    }
    .title small{
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .badge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.78);
      white-space:nowrap;
    }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 12px;
    }
    .meta .tag{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      user-select:none;
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(34,197,94,.65), rgba(96,165,250,.70));
      border-right: 1px solid rgba(255,255,255,.18);
    }
    .barLine{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted2);
      font-size: 12px;
      font-family: var(--mono);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .actions a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.88);
      font-weight: 700;
      font-size: 13px;
      transition: background .2s ease, border-color .2s ease, transform .06s ease;
      flex: 1;
      min-width: 130px;
    }
    .actions a:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
    .actions a:active{ transform: translateY(1px); }
    .actions a.primary{
      background: linear-gradient(90deg, rgba(96,165,250,.22), rgba(167,139,250,.18));
      border-color: rgba(96,165,250,.35);
    }

    footer{
      margin-top: 18px;
      color: rgba(255,255,255,.45);
      font-size: 12px;
      text-align:center;
    }

    .empty{
      margin-top: 14px;
      padding: 18px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: var(--radius);
      color: var(--muted);
      background: rgba(255,255,255,.04);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Derecho Administrativo ¬∑ Temas</h1>
        <p>√çndice visual para acceder a cada tema desde GitHub Pages. Guarda progreso local (en este dispositivo) y te deja continuar donde lo dejaste.</p>
      </div>

      <div class="topbar">
        <div class="pill" title="Tu progreso se guarda en este navegador (localStorage)">
          <small>Progreso global</small>
          <b id="globalProgress">0%</b>
        </div>
        <button class="btn primary" id="openLastBtn" type="button">Continuar</button>
        <button class="btn danger" id="resetBtn" type="button">Reset progreso</button>
      </div>
    </header>

    <div class="toolbar">
      <div class="search">
        <span style="opacity:.7">üîé</span>
        <input id="q" type="search" placeholder="Buscar tema (por n√∫mero, t√≠tulo o etiqueta)‚Ä¶" autocomplete="off" />
      </div>

      <div class="chips" id="chips"></div>
    </div>

    <section class="grid" id="grid"></section>

    <div class="empty" id="empty" style="display:none;">
      No hay resultados con ese filtro. Prueba otra b√∫squeda o quita chips.
    </div>

    <footer>
      Hecho para GitHub Pages ¬∑ Sin dependencias ¬∑ Funciona offline si guardas la p√°gina.
    </footer>
  </div>

  <script>
    // =========================
    // Config r√°pida
    // =========================
    const DATA_URL = "./temas.json"; // mismo directorio
    const LS_KEY = "da_temas_progress_v1";

    // Progreso por tema: { [idTema]: { done: number, total: number, last: string } }
    function loadProgress(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveProgress(obj){
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    function pct(done, total){
      if (!total || total <= 0) return 0;
      return Math.max(0, Math.min(100, Math.round((done / total) * 100)));
    }

    function computeGlobal(temas, prog){
      let sumDone = 0, sumTotal = 0;
      for (const t of temas){
        const p = prog[t.id] || {};
        const total = Number(p.total ?? t.totalPreguntas ?? 0);
        const done = Number(p.done ?? 0);
        if (total > 0){
          sumDone += Math.min(done, total);
          sumTotal += total;
        }
      }
      return pct(sumDone, sumTotal);
    }

    function norm(s){
      return (s || "").toString().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
    }

    // =========================
    // UI
    // =========================
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const q = document.getElementById("q");
    const chipsWrap = document.getElementById("chips");
    const globalProgressEl = document.getElementById("globalProgress");
    const openLastBtn = document.getElementById("openLastBtn");
    const resetBtn = document.getElementById("resetBtn");

    let TEMAS = [];
    let PROG = loadProgress();
    let ACTIVE_TAG = "Todos";

    function getAllTags(temas){
      const set = new Set(["Todos"]);
      for (const t of temas){
        (t.tags || []).forEach(x => set.add(x));
      }
      return Array.from(set);
    }

    function renderChips(tags){
      chipsWrap.innerHTML = "";
      tags.forEach(tag => {
        const el = document.createElement("div");
        el.className = "chip" + (tag === ACTIVE_TAG ? " active" : "");
        el.textContent = tag;
        el.addEventListener("click", () => {
          ACTIVE_TAG = tag;
          render();
          renderChips(tags);
        });
        chipsWrap.appendChild(el);
      });
    }

    function cardHTML(t){
      const p = PROG[t.id] || {};
      const total = Number(p.total ?? t.totalPreguntas ?? 0);
      const done = Number(p.done ?? 0);
      const percent = pct(done, total);

      const label = total ? `${done}/${total}` : `‚Äî/‚Äî`;
      const subtitle = `Tema ${t.id}${t.bloque ? " ¬∑ " + t.bloque : ""}`;

      const tags = (t.tags || []).slice(0, 4).map(x => `<span class="tag">${escapeHTML(x)}</span>`).join("");
      const file = t.file;

      // Bot√≥n "Continuar": si guardaste last, abre con #last (para que el tema lo use si quiere)
      const last = (p.last || "").trim();
      const contHref = last ? `${file}#${encodeURIComponent(last)}` : file;

      return `
        <article class="card" data-id="${escapeHTML(t.id)}">
          <div class="cardTop">
            <div class="title">
              <small>${escapeHTML(subtitle)}</small>
              <h3>${escapeHTML(t.titulo)}</h3>
            </div>
            <div class="badge">${percent}%</div>
          </div>

          <div class="meta">
            ${tags || `<span class="tag">Sin etiquetas</span>`}
          </div>

          <div class="bar" aria-label="progreso del tema">
            <i style="width:${percent}%"></i>
          </div>
          <div class="barLine">
            <span>${label}</span>
            <span>${t.file}</span>
          </div>

          <div class="actions">
            <a class="primary" href="${contHref}">Abrir / Continuar</a>
            <a href="${file}" title="Abrir desde el inicio">Empezar</a>
          </div>
        </article>
      `;
    }

    function escapeHTML(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      const query = norm(q.value);
      const filtered = TEMAS.filter(t => {
        const tagOk = (ACTIVE_TAG === "Todos") || (t.tags || []).includes(ACTIVE_TAG);

        if (!tagOk) return false;

        if (!query) return true;

        const hay = norm(`${t.id} ${t.titulo} ${(t.tags || []).join(" ")} ${t.bloque || ""} ${t.file || ""}`);
        return hay.includes(query);
      });

      grid.innerHTML = filtered.map(cardHTML).join("");
      empty.style.display = filtered.length ? "none" : "block";

      // progreso global
      globalProgressEl.textContent = computeGlobal(TEMAS, PROG) + "%";

      // Continuar global: abre el √∫ltimo tema que tenga "last"
      const last = findLastVisited(TEMAS, PROG);
      openLastBtn.disabled = !last;
      openLastBtn.style.opacity = last ? "1" : ".55";
      openLastBtn.style.cursor = last ? "pointer" : "not-allowed";
    }

    function findLastVisited(temas, prog){
      // Buscamos el tema con un "lastTs" m√°s reciente. Si no existe, null.
      let best = null;
      for (const t of temas){
        const p = prog[t.id];
        if (!p || !p.lastTs) continue;
        if (!best || p.lastTs > best.ts){
          best = { file: t.file, last: p.last || "", ts: p.lastTs };
        }
      }
      return best;
    }

    // =========================
    // Acciones globales
    // =========================
    openLastBtn.addEventListener("click", () => {
      const last = findLastVisited(TEMAS, PROG);
      if (!last) return;
      const href = last.last ? `${last.file}#${encodeURIComponent(last.last)}` : last.file;
      location.href = href;
    });

    resetBtn.addEventListener("click", () => {
      if (!confirm("¬øSeguro que quieres borrar el progreso guardado en este dispositivo?")) return;
      PROG = {};
      saveProgress(PROG);
      render();
    });

    q.addEventListener("input", () => render());

    // =========================
    // Carga datos
    // =========================
    (async function init(){
      try{
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo cargar temas.json");
        const data = await res.json();

        // Normalizamos: exige {id, titulo, file, tags?, bloque?, totalPreguntas?}
        TEMAS = (Array.isArray(data) ? data : []).map(x => ({
          id: String(x.id),
          titulo: String(x.titulo || x.title || `Tema ${x.id}`),
          file: String(x.file || ""),
          tags: Array.isArray(x.tags) ? x.tags.map(String) : [],
          bloque: x.bloque ? String(x.bloque) : "",
          totalPreguntas: Number(x.totalPreguntas ?? 0)
        })).filter(t => t.id && t.file);

        const tags = getAllTags(TEMAS);
        renderChips(tags);
        render();
      }catch(err){
        console.error(err);
        grid.innerHTML = `<div class="empty">Error cargando <b>temas.json</b>. Revisa que est√© en la ra√≠z y sea JSON v√°lido.</div>`;
      }
    })();
  </script>
</body>
</html>